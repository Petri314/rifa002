<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rifa 100 N√∫meros ‚Äî Amaruki (Aprobaci√≥n por Admin)</title>
  <style> :root{ --bg:#0b1020; --card:#121a33; --muted:#7f8db2; --accent:#2bb3ff; --accent2:#3ad1a1; --danger:#ff5c7a; --pending:#f3c969 }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#e6ecff}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:12px 0 6px}
    .app{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.app{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(18,26,51,.95),rgba(10,15,30,.95));border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card h2{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;padding:14px}
    @media (max-width:520px){.grid{grid-template-columns:repeat(5,1fr)}}
    .num{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 0;text-align:center;font-weight:700;cursor:pointer;user-select:none}
    .num.available{background:linear-gradient(180deg,rgba(43,179,255,.12),rgba(43,179,255,.04))}
    .num.pending{background:linear-gradient(180deg,rgba(243,201,105,.22),rgba(243,201,105,.06));border-color:rgba(243,201,105,.5)}
    .num.taken{background:linear-gradient(180deg,rgba(255,92,122,.18),rgba(255,92,122,.06));border-color:rgba(255,92,122,.45)}
    .alias-mini{font-size:10px;opacity:.9}
    .panel{padding:14px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button,textarea{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c1226;color:#eaf2ff;padding:10px 12px}
    button{cursor:pointer;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#04121c;font-weight:700}
    button.secondary{background:transparent;color:#e6ecff;border:1px solid rgba(255,255,255,.18)}
    .list{max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .tiny{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent)}
    .auth{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .avatar{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.18);object-fit:cover}
    .warn{background:#2a1320;border-color:#b74a62}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(243,201,105,.18);border:1px solid rgba(243,201,105,.4);color:#ffeec0}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">üéâ Rifa 100 N√∫meros ‚Äî Airjoelectronicos</h1>
    <div class="app">
      <section class="card">
        <div class="panel" style="padding-bottom:0">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Selecciona un n√∫mero</h2>
            <div class="row">
              <span class="pill">Disponibles: <b id="available">100</b></span>
              <span class="pill">Reservados: <b id="taken">0</b></span>
            </div>
          </div>
        </div>
        <div class="grid" id="grid"></div>
      </section>

      <aside class="card">
        <div class="panel">
          <h2>Panel de control</h2>
          <!-- Solo se mostrar√° el login al activar "Modo admin" con PIN -->
          <div class="row" style="align-items:center">
            <button id="btnAdminGate" class="secondary">üîí Modo admin</button>
            <span class="tiny">Los usuarios hacen solicitudes; el admin aprueba.</span>
          </div>
          <div class="auth" id="authArea" style="display:none">
            <div id="userBox" style="display:none;align-items:center;gap:8px;width:100%">
              <img id="userPhoto" class="avatar" alt=""/>
              <div>
                <div id="userName" style="font-weight:700"></div>
                <div id="userEmail" class="tiny"></div>
              </div>
              <button id="btnLogout" class="secondary" style="margin-left:auto">Salir</button>
            </div>
            <div id="authBox" style="width:100%">
              <div class="row"><input id="email" placeholder="admin@tu-dominio.com" style="flex:1"><input id="password" type="password" placeholder="Contrase√±a" style="flex:1"></div>
              <div class="row"><button id="btnLogin">Entrar</button><button id="btnGoogle" class="secondary">Google</button></div>
              <p class="tiny">El registro est√° desactivado para usuarios. Solo el administrador puede iniciar sesi√≥n.</p>
            </div>
          </div>
          <div class="divider"></div>

          <div class="row"><input id="alias" placeholder="Tu alias visible" style="flex:1"><button id="btnQuick">Reservar seleccionado</button></div>
          <div class="row"><input id="search" placeholder="Buscar alias o n√∫mero‚Ä¶" style="flex:1"><button id="btnExport" class="secondary">Exportar CSV</button></div>
          <div class="divider"></div>

          <div class="list" id="list"></div>
          <div class="divider"></div>

          <div id="reqSection" style="display:none">
            <h3 style="margin:0 0 6px">üì• Solicitudes pendientes <span class="tag" id="reqCount">0</span></h3>
            <div class="list" id="reqList"></div>
          </div>

          <div class="divider"></div>
          <div>
            <h3 style="margin:0 0 6px">üèÜ Premios</h3>
            <div class="row"><input id="p1" placeholder="1¬∞ Premio" style="flex:1"></div>
            <div class="row"><input id="p2" placeholder="2¬∞ Premio" style="flex:1"></div>
            <div class="row"><input id="p3" placeholder="3¬∞ Premio" style="flex:1"></div>
            <div class="row"><input id="p4" placeholder="4¬∞ Premio" style="flex:1"></div>
            
          </div>
          <div class="divider"></div>

          <table class="mobile-table"> <br>
            <h3>Datos Tranferencia</h3>
  
    <tbody>
        <tr>
            <td data-label="Etiqueta">Nombre</td>
            <td data-label="Valor">Ever Franklin Sanchez Vasquez</td>
        </tr>
        <tr>
            <td data-label="Etiqueta">RUT</td>
            <td data-label="Valor">22.435.451-7</td>
        </tr>
        <tr>
            <td data-label="Etiqueta">Entidad</td>
            <td data-label="Valor">Mercado Pago</td>
        </tr>
        <tr>
            <td data-label="Etiqueta">Tipo de Cuenta</td>
            <td data-label="Valor">Cuenta Vista</td>
        </tr>
        <tr>
            <td data-label="Etiqueta">N¬∫ de Cuenta</td>
            <td data-label="Valor">1081546700</td>
        </tr>
        <tr>
            <td data-label="Etiqueta">Email</td>
            <td data-label="Valor">fulminante7@gmail.com</td>
        </tr>
      <tr>
            <td data-label="Etiqueta">Precio</td>
            <td data-label="Valor">$3.000</td>
        </tr>
    </tbody>
</table>
          
          <div class="divider"></div>





<!-- BOT√ìN AMIGABLE + PANEL DESPLEGABLE (reemplaza tu bloque anterior) -->
<div class="wrap">
  <div class="center-card">
    <div class="card" role="region" aria-label="Bases de la rifa">
      <h1>üìú Bases de la rifa ‚Äî Airjoelectronicos</h1>
      <p class="tiny">Lee las bases antes de participar.</p>

      <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <button id="toggleBases" class="bases-btn" aria-expanded="false" aria-controls="basesPanel">
          üìò Ver / Ocultar Bases de la rifa
          <span id="chev" style="display:inline-block;margin-left:8px;transform:rotate(0deg);transition:transform .25s">‚ñæ</span>
        </button>
        <div class="pill">N√∫meros: 1‚Äì100</div>
        <div class="pill">Pendiente: amarillo</div>
        <div class="pill">Aprobado: rojo</div>
      </div>

      <p class="bases-sub">Pulsa para desplegar las reglas.</p>

      <!-- Panel colapsable -->
      <div id="basesPanel" class="collapse-content" aria-hidden="true" tabindex="-1" style="margin-top:16px">
        <!-- Contenido completo de las bases (secciones 1-11) -->
        <div class="section" id="s1">
          <strong>Organiza:</strong> Airjoelectronicos ‚Äî <span class="tiny">Rifa 100 N√∫meros</span><br>
          <span class="tiny">Fecha inicio: (indicar) ‚Ä¢ Cierre: cuando se vendan los 100 n√∫meros ‚Ä¢ Sorteo: inmediatamente tras el √∫ltimo n√∫mero vendido.</span>
        </div>

        <div class="section" id="s2">
          <h3>1. Objeto</h3>
          <p>Esta rifa ofrece a los participantes la oportunidad de ganar uno de los premios publicados. La venta se realiza por n√∫mero (1‚Äì100). Cada n√∫mero puede ser solicitado y quedar√° pendiente hasta la aprobaci√≥n del administrador.</p>
        </div>

        <div class="section" id="s3">
          <h3>2. C√≥mo participar ‚Äî selecci√≥n y estado del n√∫mero</h3>
          <ol>
            <li>El participante escribe un <strong>alias</strong> visible y selecciona el n√∫mero en la cuadr√≠cula.</li>
            <li>Al enviar la solicitud, el n√∫mero queda marcado como <strong>pendiente</strong> y aparece en la interfaz con <strong>color amarillo</strong>.</li>
            <li>La solicitud quedar√° en la secci√≥n ‚ÄúSolicitudes pendientes‚Äù para que el administrador la revise.</li>
            <li>Si el admin aprueba la solicitud, el n√∫mero pasa a <strong>confirmado</strong> y se muestra con <strong>color rojo</strong> (reservado).</li>
            <li>Si la solicitud es rechazada, el n√∫mero vuelve a estar libre.</li>
          </ol>
          <p class="muted">Nota: Con Firebase habilitado, las solicitudes y aprobaciones se visualizan en tiempo real.</p>
        </div>

        <div class="section" id="s4">
          <h3>3. L√≠mite y compra</h3>
          <p>Total de n√∫meros: <strong>100</strong>. Un n√∫mero = una participaci√≥n. Un mismo usuario puede solicitar m√°s de un n√∫mero, sujeto a aprobaci√≥n.</p>
          <p>La reserva solo se considera final cuando el administrador aprueba la solicitud (estado rojo).</p>
        </div>

        <!-- SECCI√ìN 5 (la que quieres ver de inicio al abrir) -->
        <div class="section" id="s5">
          <h3>4. Orden y mecanismo del sorteo</h3>
          <p>El sorteo se realizar√° <strong>cuando los 100 n√∫meros est√©n vendidos y confirmados</strong>. La mec√°nica es la siguiente (mec√°nica ‚Äúprimeros 3 al agua‚Äù):</p>
          <ul>
            <li>El sorteo comenzar√° por el <strong>4¬∞ premio</strong> y terminar√° en el <strong>1¬∞ premio</strong>.</li>
            <li>Para cada premio se extraen <strong>4 n√∫meros</strong> al azar de los a√∫n no premiados.</li>
            <li>Los <strong>primeros 3</strong> n√∫meros extra√≠dos quedan "al agua" (eliminados del sorteo, sin premio).</li>
            <li>El <strong>4¬∞ n√∫mero</strong> extra√≠do ser√° el ganador del premio actual.</li>
            <li>Los n√∫meros "al agua" quedan fuera del sorteo para los siguientes premios.</li>
          </ul>
          <p class="muted">Ejemplo: Para el 4¬∞ premio se extraen 4 n√∫meros ‚Üí 3 primeros descartados ‚Üí 4¬∞ es ganador. Repetir para el 3¬∞, 2¬∞ y 1¬∞ premio. </p>
        </div>

        <div class="section" id="s6">
          <h3>5. Notificaci√≥n y entrega</h3>
          <p>Los ganadores se publicar√°n en la plataforma y canales oficiales <a href="https://www.instagram.com/air_joelectronicos">Instagram</a>. Para reclamar, el ganador debe acreditar identidad y alias/n√∫mero.</p>
          <p>Plazos y modalidad de entrega ser√°n comunicados por el organizador. Si aplica env√≠o, se informar√°n costos y condiciones.</p>
        </div>

        <div class="section" id="s7">
          <h3>6. Condiciones de pago y validez</h3>
          <p>La reserva indica intenci√≥n de compra. La confirmaci√≥n final requerire pago y posterior verificaci√≥n por el admin. Si no se completa (si aplica), el admin puede liberar el n√∫mero. El comprobante se envia al WhatsApp <a href="https://wa.link/y4q8gz">+56 9 9382 2878</a> </p>
        </div>

        <div class="section" id="s8">
          <h3>7. Protecci√≥n de datos y transparencia</h3>
          <p>Se publicar√° un listado final de n√∫meros vendidos (alias parcial) cuando se completen la venta de todos los n√∫meros. Los datos personales solo se usar√°n para gesti√≥n y entrega de premios y no se compartir√°n con terceros sin consentimiento. La web para el sorteo ser√° <a href="https://sorteador.com.br/es/sorteo-lista">sorteador.com</a></p>
        </div>

        <div class="section" id="s9">
          <h3>8. Reclamaciones</h3>
          <p>Reclamos se recibir√°n al WhatsApp  +56 9 9382 2878.</p>
        </div>

        <div class="section" id="s10">
          <h3>9. Responsabilidades</h3>
          <p>La plataforma no se responsabiliza por errores de visualizaci√≥n causados por caracteres especiales o fallas del dispositivo del usuario. Verifica alias y n√∫mero antes de enviar.</p>
        </div>

        <div class="section" id="s11">
          <h3>10. Funciones del admin</h3>
          <p>Solo el admin puede aprobar/rechazar solicitudes (PIN). El admin puede exportar CSV, liberar n√∫meros y actualizar premios.</p>
        </div>

        <div class="section" id="s12">
          <h3>11. Aceptaci√≥n</h3>
          <p>Al participar, el usuario acepta estas bases en su totalidad.</p>
        </div>

        <div style="margin-top:18px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end">
          <button id="printBtn" class="bases-btn">üñ®Ô∏è Imprimir / Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estilos necesarios para el colapso -->
<style>
  .collapse-content{
    max-height: 0;
    overflow: hidden;
    transition: max-height 350ms ease, padding 250ms ease;
    padding: 0 12px;
    border-radius: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  .collapse-content.open{
    padding: 16px 12px;
    /* max-height se ajustar√° por JS al contenido real */
  }
  .bases-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#04121c;font-weight:800;border:none;cursor:pointer}
</style>

<!-- JS: toggle, animaci√≥n y scroll hacia secci√≥n 5 -->
<script>
  (function(){
    const btn = document.getElementById('toggleBases');
    const panel = document.getElementById('basesPanel');
    const chev = document.getElementById('chev');
    const printBtn = document.getElementById('printBtn');
    const targetSection = document.getElementById('s5'); // secci√≥n 5

    function openPanel(){
      panel.classList.add('open');
      // fijar max-height al scrollHeight real para animaci√≥n suave
      panel.style.maxHeight = panel.scrollHeight + 'px';
      panel.setAttribute('aria-hidden','false');
      btn.setAttribute('aria-expanded','true');
      chev.style.transform = 'rotate(180deg)';
      // foco y scroll suave hacia secci√≥n 5 despu√©s de abrir (espera la animaci√≥n)
      setTimeout(()=> {
        if(targetSection){
          // mueve el scroll interno del panel para mostrar secci√≥n 5 al inicio
          const offset = targetSection.offsetTop - panel.querySelector('.section')?.offsetTop || 0;
          panel.scrollTo({top: offset, behavior: 'smooth'});
          // enfoca la secci√≥n 5 para accesibilidad
          targetSection.setAttribute('tabindex','-1');
          targetSection.focus({preventScroll:true});
        } else {
          panel.focus();
        }
      }, 360);
    }

    function closePanel(){
      panel.style.maxHeight = panel.scrollHeight + 'px'; // asegura altura actual antes de animar
      requestAnimationFrame(()=> {
        panel.style.maxHeight = '0px';
      });
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden','true');
      btn.setAttribute('aria-expanded','false');
      chev.style.transform = 'rotate(0deg)';
      // limpiar tabindex si lo establecimos
      if(targetSection) targetSection.removeAttribute('tabindex');
    }

    btn.addEventListener('click', (e)=>{
      const isOpen = panel.classList.contains('open');
      if(isOpen) closePanel(); else openPanel();
    });

    // cerrar con tecla Esc cuando est√© abierto
    document.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Escape' && panel.classList.contains('open')) closePanel();
    });

    // imprimir
    printBtn.addEventListener('click', ()=> {
      // si est√° cerrado, abrir primero para imprimir todo el contenido
      if(!panel.classList.contains('open')) {
        openPanel();
        // espera un poco para que se expanda y luego imprimir
        setTimeout(()=> window.print(), 450);
      } else {
        window.print();
      }
    });

    // Al cambiar tama√±o de ventana, recalcula la altura si est√° abierto
    window.addEventListener('resize', ()=> {
      if(panel.classList.contains('open')) {
        panel.style.maxHeight = panel.scrollHeight + 'px';
      }
    });
  })();
</script>








          


          <div class="divider"></div>
          <details id="syncSettings" style="display:none"><summary class="tiny">‚öôÔ∏è Ajustes de sincronizaci√≥n (Firebase)</summary>
            <textarea id="cfg" rows="7" style="width:100%;margin-top:8px">{
  "apiKey": "AIzaSyAdhD7Lr-xxaaj5WHKUxtJjxwV8kT-ETi4",
  "authDomain": "rifa-90a26.firebaseapp.com",
  "databaseURL": "https://rifa-90a26-default-rtdb.firebaseio.com",
  "projectId": "rifa-90a26",
  "storageBucket": "rifa-90a26.firebasestorage.app",
  "messagingSenderId": "42485595611",
  "appId": "1:42485595611:web:ee2aa2410704a6af573bfe"
}</textarea>
            <div class="row"><button id="btnEnable">Habilitar Firebase</button><span class="tiny">(Opcional: cambia el JSON si fuera necesario)</span></div>
          </details>
          </div>
      </aside>
    </div>
  </div>

  <template id="tplItem">
    <div class="item"><div><b>#<span class="no"></span></b> ‚Äî <span class="alias"></span> <span class="tiny" style="opacity:.8">(<span class="uid"></span>)</span></div><button class="secondary btnFree">Liberar</button></div>
  </template>
  <template id="tplReq">
    <div class="item"><div><b>#<span class="no"></span></b> ‚Äî <span class="alias"></span> <span class="tiny" style="opacity:.8">(<span class="client"></span>)</span></div><div class="row"><button class="secondary btnReject">Rechazar</button><button class="btnApprove">Aprobar</button></div></div>
  </template>

  <script>
    // ===== Config r√°pida =====
    const TOTAL=100; 
    const ADMIN_EMAILS=[
      'hijodenewton3.14@gmail.com'
    ];
    const ADMIN_PIN = '3266'; // Cambia este PIN para abrir el login de admin

    // ===== Estado =====
    const state={numbers:{}, prizes:{p1:"",p2:"",p3:"",p4:""}, requests:{}, backend:'local', fb:{app:null,db:null,auth:null,ref:null}, user:null, isAdmin:false, adminGate:false, isAdminUI:false};
    const el={grid:by('grid'), list:by('list'), available:by('available'), taken:by('taken'), alias:by('alias'), search:by('search'), p1:by('p1'), p2:by('p2'), p3:by('p3'), p4:by('p4'), tpl:by('tplItem'), tplReq:by('tplReq'), email:by('email'), password:by('password'), btnLogin:by('btnLogin'), btnGoogle:by('btnGoogle'), btnLogout:by('btnLogout'), authBox:by('authBox'), userBox:by('userBox'), userName:by('userName'), userEmail:by('userEmail'), userPhoto:by('userPhoto'), btnEnable:by('btnEnable'), cfg:by('cfg'), btnQuick:by('btnQuick'), btnExport:by('btnExport'), reqList:by('reqList'), reqCount:by('reqCount'), authArea:by('authArea'), btnAdminGate:by('btnAdminGate')};
    function by(id){return document.getElementById(id)}

    // ===== Local storage =====
    function build(){const n={};for(let i=1;i<=TOTAL;i++) n[i]=null;return {numbers:n,prizes:{...state.prizes},requests:{}}}
    function load(){try{const x=localStorage.getItem('rifa_approval_v1');return x?JSON.parse(x):null}catch(e){return null}}
    function save(){try{localStorage.setItem('rifa_approval_v1',JSON.stringify({numbers:state.numbers,prizes:state.prizes,requests:state.requests}))}catch(e){}}

    function apply(snap,{silent}={}) {
  state.numbers = snap && snap.numbers ? snap.numbers : {};
  // si snap.prizes no viene, usa defaults con p4 incluido
  state.prizes = snap && snap.prizes ? snap.prizes : { p1: "", p2: "", p3: "", p4: "" };
  state.requests = snap && snap.requests ? snap.requests : {};
  render();
  if (!silent && state.backend === 'local') save();
}

    // ===== Arranque con restauraci√≥n de modo admin y Firebase auto =====
    function init(){
      const x=load();
      apply(x||build(),{silent:true});
      try{ state.adminGate = localStorage.getItem('rifa_admin_gate')==='1'; state.isAdminUI = localStorage.getItem('rifa_admin_ui')==='1'; if(state.adminGate){ document.getElementById('authArea').style.display=''; } }catch(e){}
      render();
      try{ enableFb(true); }catch(e){}
    }

    // ===== Notificaciones =====
    function beep(){
      try{
        const Ctx = window.AudioContext || window.webkitAudioContext; if(!Ctx) return;
        const ctx = new Ctx();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.15); o.stop(ctx.currentTime+0.2); ctx.close(); }, 180);
      }catch(e){}
    }
    function setTitleCount(){
      const c = Object.keys(state.requests||{}).length;
      const base = 'Rifa 100 N√∫meros ‚Äî Amaruki (Aprobaci√≥n por Admin)';
      document.title = c>0 ? `(${c}) ${base}` : base;
      el.reqCount.textContent = c;
    }

    // ===== Render =====
    function render(){
  renderCounts();
  renderGrid();
  renderList();
  renderReqs();
  el.p1.value = state.prizes.p1 || '';
  el.p2.value = state.prizes.p2 || '';
  el.p3.value = state.prizes.p3 || '';
  el.p4.value = state.prizes.p4 || ''; // <-- agregado
  setTitleCount();
  toggleAdminSections();
}

    function renderCounts(){const t=Object.values(state.numbers).filter(v=>v).length; el.taken.textContent=t; el.available.textContent=TOTAL-t;}
    function isPending(no){ return !!Object.values(state.requests).find(r=>r.no===no); }
    function renderGrid(){ el.grid.innerHTML=''; const term=(el.search.value||'').toLowerCase(); for(let i=1;i<=TOTAL;i++){const v=state.numbers[i]; const pending=isPending(i); const d=document.createElement('div'); d.className='num '+(v?'taken':(pending?'pending':'available')); const aliasMini=v? v.alias : (pending? 'Pendiente' : ''); d.innerHTML=`${i}<div class=\"alias-mini\">${aliasMini}</div>`; if(term){const m=(''+i).includes(term)|| (v&&v.alias.toLowerCase().includes(term)); d.style.opacity=m?1:.35;} d.onclick=()=>onNumber(i); el.grid.appendChild(d);} }
    function renderList(){ el.list.innerHTML=''; const frag=document.createDocumentFragment(); Object.entries(state.numbers).filter(([n,v])=>v).sort((a,b)=>a[0]-b[0]).forEach(([no,obj])=>{ const node=el.tpl.content.firstElementChild.cloneNode(true); node.querySelector('.no').textContent=no; node.querySelector('.alias').textContent=obj.alias; node.querySelector('.uid').textContent=(obj.uid||'admin').slice(0,6); const btn=node.querySelector('.btnFree'); btn.disabled=!state.isAdminUI; btn.onclick=()=>{ if(!state.isAdminUI){alert('Solo el admin puede liberar.');return;} release(parseInt(no)); }; frag.appendChild(node); }); el.list.appendChild(frag); }
    function renderReqs(){ el.reqList.innerHTML=''; const entries=Object.entries(state.requests).sort((a,b)=>a[1].ts-b[1].ts); const frag=document.createDocumentFragment(); for(const [id,r] of entries){ const node=el.tplReq.content.firstElementChild.cloneNode(true); node.querySelector('.no').textContent=r.no; node.querySelector('.alias').textContent=r.alias; node.querySelector('.client').textContent=(r.clientId||'usr').slice(0,6); const btnA=node.querySelector('.btnApprove'); const btnR=node.querySelector('.btnReject'); const canAdmin = state.isAdminUI; btnA.disabled=!canAdmin; btnR.disabled=!canAdmin; btnA.onclick=()=>approveReq(id); btnR.onclick=()=>rejectReq(id); frag.appendChild(node);} el.reqList.appendChild(frag); }

    // ===== Flujo usuario (solicitud) =====
    el.btnQuick.onclick=()=>{ const a=(el.alias.value||'').trim(); if(!a){alert('Escribe tu alias.'); return;} alert('Toca en la cuadr√≠cula el n√∫mero que quieres solicitar.'); };
    function onNumber(no){ const cur=state.numbers[no]; if(cur){ alert('Ese n√∫mero ya est√° reservado.'); return; } if(isPending(no)){ alert('Ese n√∫mero ya tiene una solicitud pendiente.'); return; } const a=(el.alias.value||'').trim(); if(!a){ alert('Escribe tu alias.'); el.alias.focus(); return;} createRequest(no,a); }
    function createRequest(no,alias){ const id='req_'+Date.now()+"_"+Math.random().toString(36).slice(2,7); const req={id,no,alias,ts:Date.now(),clientId:getClientId()}; state.requests[id]=req; render(); if(state.backend==='firebase') setRequest(id,req); else save(); alert(`Solicitud enviada para el n√∫mero #${no}. Espera aprobaci√≥n del admin.`); }

    // ===== Flujo admin (versi√≥n anterior estable) =====
    async function approveReq(id){ const r=state.requests[id]; if(!r) return; if(!state.isAdminUI){ alert('Solo el admin puede aprobar.'); return; }
      if(state.numbers[r.no]){ delete state.requests[id]; persistRequests(); render(); return; }
      const obj={alias:r.alias, uid: state.user? state.user.uid : 'admin'};
      // Optimista en UI
      state.numbers[r.no]=obj; delete state.requests[id]; render();
      if(state.backend==='firebase'){
        if(!state.isAdmin){ alert('Debes iniciar sesi√≥n como admin para escribir en la base de datos.'); return; }
        try{ await fbUpdate({[`numbers/${r.no}`]: obj, [`requests/${id}`]: null}); }
        catch(e){ alert('No pude guardar en Firebase (approve): '+(e.message||e)); }
      } else save(); }
    async function rejectReq(id){ if(!state.isAdminUI){ alert('Solo el admin puede rechazar.'); return; } if(!state.requests[id]) return; delete state.requests[id]; render(); if(state.backend==='firebase'){ if(!state.isAdmin){ alert('Debes iniciar sesi√≥n como admin para escribir en la base de datos.'); return; } try{ await fbUpdate({[`requests/${id}`]: null}); }catch(e){ alert('No pude guardar en Firebase (reject): '+(e.message||e)); } } else save(); }

    async function release(no){ if(!state.isAdminUI){ alert('Solo el admin puede liberar.'); return; } const cur=state.numbers[no]; if(!cur) return; state.numbers[no]=null; render(); if(state.backend==='firebase'){ if(!state.isAdmin){ alert('Debes iniciar sesi√≥n como admin para escribir en la base de datos.'); return; } try{ await fbUpdate({[`numbers/${no}`]: null}); }catch(e){ alert('No pude guardar en Firebase (release): '+(e.message||e)); } } else save(); }

    function persistRequests(){ if(state.backend==='firebase'){} else save(); }

    function getClientId(){ try{ let id=localStorage.getItem('rifa_client_id'); if(!id){ id='c_'+Math.random().toString(36).slice(2,10); localStorage.setItem('rifa_client_id',id);} return id; }catch(e){ return 'client'; } }

    // CSV
    el.btnExport.onclick=()=>{
    // 1. Quitar 'uid' de la cabecera
    const rows=[
        ["numero", "alias"],
        ...Object.entries(state.numbers)
            .filter(([n,v])=>v)
            .map(([n,v])=>[n,v.alias]) // 2. Quitar v.uid||'admin'
    ];
    
    const csv=rows.map(r=>r.map(x=>`"${(x+"").replaceAll('"','\"')}"`).join(',')).join('\n'); 
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); 
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); 
    a.href=url; 
    a.download='rifa.csv'; 
    a.click(); 
    URL.revokeObjectURL(url); 
};
    // Search
    el.search.addEventListener('input',()=>{renderGrid();renderList();});

    // ===== Admin Gate (PIN) =====
    el.btnAdminGate.onclick=()=>{ const p=prompt('PIN de administrador:'); if(p===ADMIN_PIN){ state.adminGate=true; state.isAdminUI=true; try{ localStorage.setItem('rifa_admin_gate','1'); localStorage.setItem('rifa_admin_ui','1'); }catch(e){} document.getElementById('authArea').style.display=''; toggleAdminSections(); } else if(p){ alert('PIN incorrecto'); } };

    // ===== Firebase =====
    el.btnEnable.onclick=()=>enableFb(false);
    async function enableFb(silent){ if(state.backend==='firebase' && state.fb.app) return state.fb.app; try{ const cfg=JSON.parse(el.cfg.value.trim()); await ensureFb(); const app=firebase.initializeApp(cfg); const db=firebase.database(); const auth=firebase.auth(); const ref=db.ref('rifa100/default'); state.backend='firebase'; state.fb={app,db,auth,ref}; // init if empty
      ref.child('snapshot').get().then(s=>{ if(!s.exists()) ref.child('snapshot').set(build()); });
      ref.child('snapshot').on('value',s=>{ if(s.exists()) apply(s.val(),{silent:true}); render(); });
      // requests realtime con notificaci√≥n
      ref.child('snapshot/requests').on('value',s=>{ 
        const prev = new Set(Object.keys(state.requests||{}));
        const next = s.exists()? s.val(): {};
        state.requests = next || {};
        const nowIds = new Set(Object.keys(state.requests));
        let newCount = 0; nowIds.forEach(id=>{ if(!prev.has(id)) newCount++; });
        renderReqs(); renderGrid(); setTitleCount();
        if(state.isAdminUI && state.isAdmin && newCount>0){ beep(); }
      });
      auth.onAuthStateChanged(u=>{ state.user=u||null; const email=(u?.email||'').toLowerCase(); state.isAdmin = !!(u && ADMIN_EMAILS.includes(email)); updateAuthUI(); if(u && !el.alias.value){ el.alias.value=u.displayName|| (u.email?u.email.split('@')[0]:''); } if(state.isAdminUI){ toggleAdminSections(); } });
      if(!silent) alert('Firebase habilitado. Inicia sesi√≥n solo si eres admin.');
      return app;
    }catch(e){ if(!silent) alert('No se pudo habilitar Firebase. Revisa el JSON.\n'+e); throw e; } }

    function setNumber(no,obj){ return state.fb.ref.child(`snapshot/numbers/${no}`).set(obj); }
    function setRequest(id,obj){ return state.fb.ref.child(`snapshot/requests/${id}`).set(obj); }
    function delRequest(id){ return state.fb.ref.child(`snapshot/requests/${id}`).remove(); }
    function fbUpdate(upd){ return state.fb.ref.child('snapshot').update(upd); }

    function updateAuthUI(){ const u=state.user; const gate=state.adminGate; const area=document.getElementById('authArea'); area.style.display = gate? '' : 'none';
      if(u){ el.authBox.style.display='none'; el.userBox.style.display='flex'; el.userName.textContent=u.displayName|| (u.email?u.email.split('@')[0]:''); el.userEmail.textContent=u.email||''; el.userPhoto.src=u.photoURL||'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\"><rect width=\"100%\" height=\"100%\" fill=\"%23121a33\"/><text x=\"50%\" y=\"54%\" fill=\"white\" font-family=\"Arial\" font-size=\"22\" text-anchor=\"middle\">üë§</text></svg>'; }
      else { el.authBox.style.display='block'; el.userBox.style.display='none'; }
      toggleAdminSections();
    }
    function toggleAdminSections(){ const sec=document.getElementById('reqSection'); if(sec){ sec.style.display = state.isAdminUI? '' : 'none'; } const sync=document.getElementById('syncSettings'); if(sync){ sync.style.display = state.isAdminUI? '' : 'none'; } }

    // Auth buttons (sin registro p√∫blico)
    document.getElementById('btnLogin').onclick=async ()=>{ try{ if(!state.fb.app){ await enableFb(true); } await ensureFb(); if(!state.adminGate){ alert('Solo el admin puede iniciar sesi√≥n.'); return; } const email=el.email.value.trim().toLowerCase(); if(!ADMIN_EMAILS.includes(email)){ alert('Correo no autorizado como administrador.'); return;} await firebase.auth().signInWithEmailAndPassword(email, el.password.value); state.isAdminUI=true; try{ localStorage.setItem('rifa_admin_ui','1'); }catch(e){} toggleAdminSections(); }catch(e){ alert('Error al iniciar sesi√≥n: '+e.message);} };
    document.getElementById('btnGoogle').onclick=async ()=>{ try{ if(!state.fb.app){ await enableFb(true); } await ensureFb(); if(!state.adminGate){ alert('Solo el admin puede iniciar sesi√≥n.'); return; } const provider=new firebase.auth.GoogleAuthProvider(); const cred=await firebase.auth().signInWithPopup(provider); const email=(cred.user?.email||'').toLowerCase(); if(!ADMIN_EMAILS.includes(email)){ await firebase.auth().signOut(); alert('Esa cuenta no est√° autorizada como administrador.'); return; } state.isAdminUI=true; try{ localStorage.setItem('rifa_admin_ui','1'); }catch(e){} toggleAdminSections(); }catch(e){ alert('Error con Google: '+e.message);} };
    document.getElementById('btnLogout').onclick=async ()=>{ try{ await firebase.auth().signOut(); state.isAdmin=false; state.isAdminUI=false; try{ localStorage.removeItem('rifa_admin_ui'); localStorage.removeItem('rifa_admin_gate'); }catch(e){} toggleAdminSections(); setTitleCount(); }catch(e){ alert('Error al salir: '+e.message);} };

    async function ensureFb(){ if(window.firebase) return; await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js'); await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js'); await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js'); }
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

    function escapeHtml(str){ return str.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // Boot
    init();
  </script>
</body>
</html>
